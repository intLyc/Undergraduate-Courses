CREATE SCHEMA `Library` DEFAULT CHARACTER SET utf8 ;

CREATE TABLE `Library`.`User` (
  `UID` VARCHAR(20) NOT NULL,
  `Password` VARCHAR(20) NOT NULL,
  PRIMARY KEY (`UID`));

CREATE TABLE `Library`.`Root` (
  `RID` VARCHAR(20) NOT NULL,
  `Password` VARCHAR(20) NOT NULL,
  PRIMARY KEY (`RID`));

CREATE TABLE `Library`.`Book` (
  `BID` VARCHAR(20) NOT NULL,
  `Bname` VARCHAR(20) NULL,
  `Author` VARCHAR(20) NULL,
  `PHouse` VARCHAR(20) NULL,
  PRIMARY KEY (`BID`));

CREATE TABLE `Library`.`Stock` (
  `BID` VARCHAR(20) NOT NULL,
  `Snum` INT NULL,
  PRIMARY KEY (`BID`),
  CONSTRAINT `fk_SBID`
    FOREIGN KEY (`BID`)
    REFERENCES `Library`.`Book` (`BID`));

CREATE TABLE `Library`.`Lend` (
  `UID` VARCHAR(20) NOT NULL,
  `BID` VARCHAR(20) NOT NULL,
  `Ldate` DATE NOT NULL,
  PRIMARY KEY (`UID`, `BID`),
  CONSTRAINT `fk_LBID`
    FOREIGN KEY (`BID`)
    REFERENCES `Library`.`Book` (`BID`),
  CONSTRAINT `fk_LUID`
    FOREIGN KEY (`UID`)
    REFERENCES `Library`.`User` (`UID`));

DELIMITER $
CREATE TRIGGER tg_lend
AFTER INSERT ON Lend
FOR EACH ROW
BEGIN
UPDATE Stock SET Snum = Snum-1 WHERE BID = NEW.BID;
END$

DELIMITER $
CREATE TRIGGER tg_return
AFTER DELETE ON Lend
FOR EACH ROW
BEGIN
UPDATE Stock SET Snum = Snum+1 WHERE BID = OLD.BID;
END$